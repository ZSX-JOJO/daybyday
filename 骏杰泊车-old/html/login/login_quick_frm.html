<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="maximum-scale=1.0, minimum-scale=1.0, user-scalable=0, initial-scale=1.0, width=device-width"/>
<meta name="format-detection" content="telephone=no, email=no, date=no, address=no">
<title>Hello APP</title>
<link rel="stylesheet" type="text/css" href="../../css/aui-flex.css" />
<link rel="stylesheet" type="text/css" href="../../css/aui.css" />
<link rel="stylesheet" type="text/css" href="../../css/common.css" />
<link rel="stylesheet" type="text/css" href="../../css/login.css" />
<script type="text/javascript" src="../../script/dot.min.js"></script>
<style>
	/*获取验证码*/
	.loginItem .getCode {
		position: absolute;
		right: 1.25rem;
		top: 0;
		color: #999;
		font-size: 0.6rem;
		line-height: 2.4rem;
		z-index: 10;
	}
	/*倒计时*/
	.loginItem span {
		position: absolute;
		right: 0;
		top: 0;
		color: #999;
		font-size: 0.6rem;
		line-height: 2.4rem;
		z-index: 10;
	}
</style>
</head>
<body>
	<div id="doT-Html"></div>
	<script type="text/x-dot-template" id="doT-Template">
	<div class="aui-content">
		<div class="close" tapmode onclick="api.closeWin();"><img src="../../image/close.png" alt=""></div>
		<div class="topInfo aui-flex-col aui-flex-middle aui-flex-between">
			<div class="aui-flex-item-7">
				<div class="title">注册/登录</div>
				<div class="text">请输入您的手机号码，<br>登录或注册您的骏杰泊车账号</div>
			</div>
			<div><img src="../../image/logo.png" alt="" style="width: 4.05rem;"></div>
		</div>
		<ul id="tabUl" class="aui-flex-col aui-flex-between aui-flex-middle">
			<!-- <li tapmode onClick="setGroup('loginGroup',0);">账号登录</li> -->
			<li tapmode onclick="toLogin();">账号登录</li>
			<li class="aui-active">快速登录</li>
		</ul>
		<div class="loginForm">
			<div class="loginItem aui-flex-col aui-flex-middle">
				<div><img src="../../image/login/6.png" alt=""></div>
				<div class="flex-auto"><input type="text" placeholder="请输入手机号" maxlength="11" id="mobile"></div>
			</div>
			<div class="loginItem aui-flex-col aui-flex-middle">
				<div><img src="../../image/login/7.png" alt=""></div>
				<div class="flex-auto relative"><input type="text" placeholder="请输入验证码" id="code"><div class="getCode" id="getCode" tapmode onclick="getCode(this)">获取验证码</div><span id="count"></span></div>
			</div>
			<div class="loginItem aui-flex-col aui-flex-middle">
				<div><img src="../../image/login/9.png" alt=""></div>
				<div class="flex-auto"><input type="text" placeholder="请输入邀请码（选填）" id="yaoqing"></div>
			</div>
		</div>
		<div class="com-btm-btn" tapmode onclick="login()">确定</div>
		<div class="aui-text-center aui-font-size-12" style="margin: 0.75rem 0 1.2rem;">
			点击“确定”，即表示阅读并同意<span class="text-common">《泊车服务条款》</span>
		</div>
		<div class="thirdTtl"><span>第三方登录</span></div>
		<ul class="snsUl aui-flex-col aui-flex-center">
			<li tapmode onclick="wx_login()"><img src="../../image/login/10.png" alt=""></li>
			<li tapmode onclick="aliPayPlus_login()"><img src="../../image/login/11.png" alt=""></li>
		</ul>
	</div>
	</script>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript">
    document.querySelector("#doT-Html").innerHTML = doT.template(document.querySelector("#doT-Template").innerHTML)();
    var aliPayPlus,wx;
	apiready = function(){
		api.parseTapmode();
		var aliPayPlus = api.require('aliPayPlus');
		var wx = api.require('wx');
	};
	// 重新发送验证码
	var wait = 60;
	function time(){
		if(wait == 0){
			document.getElementById("count").innerHTML = "";
			document.getElementById("getCode").innerHTML = "获取验证码";
			wait = 60;
		}else{
			document.getElementById("getCode").innerHTML = "重新获取验证码";
			document.getElementById("count").innerHTML = "(" + wait + ")";
			wait--;
			setTimeout(function(){
				time();
			},1000);
		}
	}
	function toLogin(){
		api.openFrame({
		    name: 'login_frm',
		    url: './login_frm.html',
		    rect: {
		        x: 0,
		        y: 0,
		        w: 'auto',
		        h: 'auto'
		    },
		    pageParam: {
		        name: 'value'
		    },
		    bounces: false
		});
	}
	// 检查手机号
	function checkMobile(){
		var mobile = document.getElementById("mobile").value;
		var phoneRule = /^0?1[3|4|5|7|8][0-9]\d{8}$/;
		if(mobile.length == 0){
			api.toast({
			    msg: '手机号不能为空',
			    location:'middle'
			});
			return false;
		}else if(!phoneRule.test(mobile)){
			api.toast({
			    msg: '手机号不合法!',
			    location:'middle'
			});
			return false;
		}
		return mobile;
	}
	//获取验证码
	function getCode(thiscode){
		document.getElementById("mobile").blur();
		document.getElementById("code").blur();
		if(wait == 60 && checkMobile()){
			time();
			var mobile = document.getElementById("mobile").value;
			var code = document.getElementById("code").value;
			var postData = {};
			postData.mobile = mobile;
			postData.code = code;
			api.ajax({
			    url: BASE_URL +'App/Login/userCode',
			    method: 'post',
			    headers: {
		            'DM-APPKEY': '123456'
		        },
			    data: {
			        values:postData
			    }
			}, function(ret, err) {
			    if (ret) {
			    	if(ret.code == "1"){
			    		alert(JSON.stringify(ret));
			    	}
			    }else{
			    	alert(JSON.stringify(err));
			    }
			});
		}
	}
	// 登录
	function login(){
		// document.getElementById("mobile").blur();
		// document.getElementById("code").blur();
		document.getElementById("yaoqing").blur();
		// var mobile = document.getElementById("mobile").value;
		var code = document.getElementById("code").value;
		var yaoqing = document.getElementById("yaoqing").value;
		var postData = {};
		postData.mobile = checkMobile();
		postData.code = code;
		if(checkMobile()){
			if(!(postData.code && postData.mobile)){
				api.toast({
				    msg: '请输入验证码',
				    location:'middle'
				});
				return;
			}
			api.ajax({
			    url: BASE_URL + 'App/Login/userQuickLanding',
			    method: 'post',
			    data: {
			        values:postData
			    }
			}, function(ret, err) {
			    if (ret) {
			    	if(ret.code == "1"){
			    		api.toast({
				    	    msg: '登录成功',
				    	    location:'middle'
				    	});
				    	$api.setStorage('userid', ret.data.userid);
				    	api.sendEvent({
	                        name: 'loginSuccessEvent'
	                    });
				    	// 登录成功 跳转到首页
				    	setTimeout(function() {
	                        api.closeToWin({
	                            name: 'root'
	                        });
	                    }, 300);
			    	}else if(ret.code == "-1"){
			    		// alert(JSON.stringify(ret.msg));
			    	}
			    } else {
			        // alert(JSON.stringify(err));
			    }
			});
		}
	}
	// 第三方登录 微信
	function wx_login(){
		wx.isInstalled(function(ret, err) {
		    if (ret.installed) {
		        alert("当前设备已安装微信客户端");
		    } else {
		        alert('当前设备未安装微信客户端');
		    }
		});
	}
	// 第三方登录 支付宝
	function aliPayPlus_login(){
		// aliPayPlus.authDirect({
		//     authInfoStr: '*****'
		// }, function(ret) {
		//     alert(JSON.stringify(ret));
		// });
		aliPayPlus.auth({
		    appId: '2017110709782441',
		    partner: '2088821543389669',
		    targetId: 'kkkkk091125',
		    rsa2: false,
		    authType:'LOGIN'
		}, function(ret) {
			if(ret){
				alert(JSON.stringify(ret));
			}else{
				alert(JSON.stringify(err));
			}
		});
	}
</script>
</html>
