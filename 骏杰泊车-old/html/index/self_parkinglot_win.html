<!DOCTYPE HTML>
<html>

<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0, minimum-scale=1.0, user-scalable=0, initial-scale=1.0, width=device-width" />
    <meta name="format-detection" content="telephone=no, email=no, date=no, address=no">
    <title>Hello APP</title>
    <link rel="stylesheet" type="text/css" href="../../css/aui.css" />
    <link rel="stylesheet" type="text/css" href="../../css/common.css" />
    <style>
    </style>
</head>

<body>
    <header class="aui-bar aui-bar-nav aui-bar-light" id="header">
        <div class="aui-pull-left" tapmode onclick="closeWin()">
            <img src="../../image/index/47.png" class="img-icon" />
        </div>
        <div class="aui-title">停车场位置</div>
    </header>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript">
    var aMap;
    function closeWin(){
        // aMap.close();
        api.closeWin();
    }
    var parkData;
    apiready = function() {
        parkData = api.pageParam.parkData;
        api.parseTapmode();
        var header = $api.byId('header');
        $api.fixStatusBar(header);
        var headerH = $api.offset(header).h;
        aMap = api.require('aMap');
        aMap.open({
            rect: {
                x: 0,
                y: headerH,
                w: api.winWidth,
                h: api.winHeight-headerH
            },
            showUserLocation: true,
            zoomLevel: 17,
            center: {
                lon: 116.4021310000,
                lat: 39.9994480000
            },
            fixedOn: api.frameName,
            fixed: true
        }, function(ret, err) {
            if (ret.status) {
                aMap.setCenter({
                    coords: {
                        lon: parkData.park_lng,
                        lat: parkData.park_lat
                    },
                    animation: false
                });
                api.openFrame({
                    name: 'self_parkinglot_frm',
                    url: 'self_parkinglot_frm.html',
                    rect: {
                        x: 0,
                        y: api.winHeight-150,
                        w: 'auto',
                        h: '150'
                    },
                    pageParam: {
                        parkData:parkData
                    },
                    bounces: false
                });
                // aMap.addAnnotations({
                //     annotations: [{
                //         id: 1,
                //         lon: parkData.park_lng,
                //         lat: parkData.park_lat
                //     }],
                //     // icons: ['widget://'],
                //     draggable: true,
                //     timeInterval: 2.0
                // }, function(ret) {
                // });
                api.showProgress({
                    style: 'default',
                    animationType: 'fade',
                    title: '定位中',
                    text: '',
                    modal: false
                });

                aMap.getLocation(function(res, err) {
                    if (res.status) {
                        aMap.searchRoute({
                            type: 'drive',
                            policy: 'drive_fee_first',
                            start: {
                                lon: res.lon,
                                lat: res.lat
                            },
                            end: {
                                lon: parkData.park_lng,
                                lat: parkData.park_lat
                            }
                        }, function(ret, err) {
                            if (ret.status) {
                                aMap.drawRoute({
                                    id: 1,
                                    autoresizing: false,
                                    index: 0,
                                    styles: {
                                        walkLine: {
                                            width: 3,
                                            color: '#698B22',
                                            lineDash: false,
                                            strokeImg: ''
                                        },
                                        driveLine: {
                                            width: 6,
                                            color: '#0000EE',
                                            lineDash: false,
                                            strokeImg: ''
                                        },
                                        busLine: {
                                            width: 4,
                                            color: '#00BFFF',
                                            lineDash: false,
                                            strokeImg: ''
                                        },
                                        icons: {
                                            start: '',
                                            end: '',
                                            bus: '',
                                            car: '',
                                            man: ''
                                        }
                                    }
                                });
                            }
                        });
                    }
                    api.hideProgress();

                });

            }
        });
        api.addEventListener({
            name: 'keyback'
        }, function(ret, err){
            if( ret ){
                closeWin();
            }
        });



    };
</script>

</html>
