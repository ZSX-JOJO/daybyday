<!DOCTYPE HTML>
<html>
<head>
<meta charset="utf-8">
<meta name="viewport" content="maximum-scale=1.0, minimum-scale=1.0, user-scalable=0, initial-scale=1.0, width=device-width" />
<meta name="format-detection" content="telephone=no, email=no, date=no, address=no">
<title>Hello APP</title>
<link rel="stylesheet" type="text/css" href="../../css/aui.css" />
<link rel="stylesheet" type="text/css" href="../../css/common.css" />
<style>
	body {
		background: #f6f8fa;
	}
	.info {
		background: #fff;
		padding: 0 0.75rem;
	}
	.airport-info img.img-arrow {
		margin-top: 1.2rem;
		display: inline-block !important;
		width: 1.05rem !important;
		height: auto !important;
	}
	.aui-info {
		height: 2.5rem;
	}
	.info .aui-info-item img.arrowRight {
		height: 0.5rem;
		display: block;
	}
	.aui-card-list-footer {
		height: 2.5rem;
		line-height: 2.5rem;
		padding-top: 0;
		padding-bottom: 0;
		background: #fff;
	}
	.aui-card-list-footer img.img-icon {
		display: inline-block !important;
		width: auto !important;
		height: 0.8rem !important;
		position: relative;
		top: 2px;
		margin-right: 0.2rem;
	}
	.info .aui-info-item img.data-icon {
		width: auto;
		height: 0.65rem !important;
	}
	.info .aui-info-item img.airport-icon {
		height: 0.6rem;
		margin-left: 0.5rem;
		width: 0.75rem;
		display: block;
	}
	.padding-t-b {
		padding-top: 0.75rem;
		padding-bottom: 0.45rem;
	}
	.aui-card-list {
		margin-bottom: 0;
	}
	.aui-grid .aui-grid-label.airport-name {
		font-size: 0.85rem;
	}
	@media all and (max-width:350px){
		.aui-grid .aui-grid-label.airport-name {
			font-size: 0.75rem;
		}
	}
</style>
</head>

<body>
<section class="aui-content">
	<div>
		<div class="aui-font-size-12 aui-text-center padding-t-b">出发/目的机场</div>
		<div class="aui-card-list">
			<div class="aui-card-list-content aui-grid airport-info">
				<div class="aui-row aui-padded-l-15 aui-padded-r-15">
					<div class="aui-col-xs-5" tapmode onClick="selectItem('depart_airport_win');">
						<p class="font-size-13">出发机场</p>
						<div class="aui-grid-label text-common airport-name" id="depart_name" data-status="-1">定位中</div>
					</div>
					<div class="aui-col-xs-2 arrow-wrap"> <img src="../../image/index/56.png" class="img-arrow" /> </div>
					<div class="aui-col-xs-5" tapmode onClick="selectItem('destination_airport_win','dest_name');">
						<p class="font-size-13">目的机场</p>
						<div class="aui-grid-label text-common airport-name" id="dest_name">请选择</div>
					</div>
				</div>
			</div>
		</div>
	</div>
	<div>
		<div class="aui-font-size-12 aui-text-center padding-t-b">出发日期</div>
		<div class="aui-info info text-dark" tapmode onclick="selectItem('reserve_date_win');">
			<div class="aui-info-item font-size-15">请选择出发日期</div>
			<div class="aui-info-item aui-padded-r-15 right-arrow">
				<p class="aui-margin-r-5"><img src="../../image/index/57.png" alt="" class="data-icon"></p>
				<p id="depart_date"></p>
			</div>
		</div>
	</div>
	<div>
		<div class="aui-font-size-12 aui-text-center padding-t-b">选择航班</div>
		<div class="aui-info info text-dark" tapmode onclick="openHangban();">
			<div class="aui-info-item font-size-15">
				<div>请选择航班</div>
				<div><img src="../../image/index/58.png" alt="" class="airport-icon"></div>
			</div>
			<div class="aui-info-item aui-padded-r-15 right-arrow">
				<p id="flight_name"></p>
			</div>
		</div>
	</div>
	<div class="aui-padded-15" style="margin-top: 4rem;">
		<div class="com-btm-btn" tapmode onClick="nextStep();">下一步</div>
	</div>
</section>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/dom7.js"></script>
<script type="text/javascript">
	var aMapLBS;
	var park_id;
	var parkData;
    apiready = function() {
    	api.parseTapmode();
    	park_id = api.pageParam.park_id;
		parkData = api.pageParam.parkData;
		aMapLBS = api.require('aMapLBS');
		aMapLBS.configManager({
		    accuracy: 'hundredMeters',
		    filter: 1
		}, function(ret, err) {
		    if (ret.status) {
				getUserCity();
		    }
		});
    };
	// 打开选择航班
	function openHangban(){
		var pageParam = {};
		pageParam.dep = document.getElementById("depart_name").getAttribute("data-AirportCode");
		pageParam.arr = document.getElementById("dest_name").getAttribute("data-AirportCode");
		pageParam.date = document.getElementById("depart_date").textContent;
		pageParam.wname = api.winName;
		pageParam.fname = api.frameName;
		// console.log(JSON.stringify(pageParam))
		api.openWin({
		    name: 'select_flight_win',
		    url: 'select_flight_win.html',
		    pageParam: pageParam
		});

	}
	// 获取用户当前所在城市
	function getUserCity(){
		aMapLBS.singleAddress({
		    timeout: 10
		}, function(ret, err) {
		    if (ret.status) {
		        // alert(JSON.stringify(ret));
				// 获取当前机场
				loadAirport(ret.address.city);

		    }
		});
	}
	function loadAirport(city){
		var postData = {};
		postData.name = city.replace("市",'');
		api.ajax({
		    url: BASE_URL+"App/Parking/departure",
		    method: 'post',
		    data: {
		        values: postData
		    }
		},function(ret, err){
		    if (ret) {
		        if(ret.data){
					api.writeFile({
						path: 'fs://parkData/'+city+".json",
						data: JSON.stringify(ret.data)
					}, function(ret, err) {
					});
					document.getElementById("depart_name").textContent = ret.data[0].AirportCname;
					document.getElementById("depart_name").setAttribute("data-status",1);
					document.getElementById("depart_name").setAttribute("data-AirportCode",ret.data[0].AirportCode);
					document.getElementById("depart_name").setAttribute("data-CityCode",ret.data[0].CityCode);
				}
		    }
		});

	}
	//修改项目
	function selectItem(url,domId){
		api.openWin({
			name: url,
			url: url + '.html',
			slidBackEnabled:false,
			pageParam: {
				domId:domId,
				wname: api.winName,
				fname: api.frameName
			}
		});
	}
	//返回数据更改
	function changeAirPortData(domId,name,CityCode,AirportCode){
		$$('#'+ domId).text(name);
		document.getElementById(domId).setAttribute("data-CityCode",CityCode);
		document.getElementById(domId).setAttribute("data-AirportCode",AirportCode);
	}
	function changeFlightData(FlightCompany,FlightNo,FlightDeptimePlanDate,FlightArrtimePlanDate,FlightDepAirport,FlightArrAirport){
		document.getElementById("flight_name").textContent = FlightCompany+FlightNo;
		document.getElementById("flight_name").setAttribute("data-FlightCompany",FlightCompany);
		document.getElementById("flight_name").setAttribute("data-FlightNo",FlightNo);
		document.getElementById("flight_name").setAttribute("data-FlightDeptimePlanDate",FlightDeptimePlanDate);
		document.getElementById("flight_name").setAttribute("data-FlightArrtimePlanDate",FlightArrtimePlanDate);

		document.getElementById("flight_name").setAttribute("data-FlightDepAirport",FlightDepAirport);
		document.getElementById("flight_name").setAttribute("data-FlightArrAirport",FlightArrAirport);
	}

	//下一步
	function nextStep(){
		var data_departure_airport = document.getElementById("depart_name").textContent;//出发机场
		var data_airport_1 = document.getElementById("dest_name").textContent;//目的机场
		var data_departure_time = document.getElementById("depart_date").textContent;//出发日期
		if(!data_departure_time){
			selectItem('reserve_date_win');
			return;
		}
		// var flight_name = document.getElementById("flight_name").textContent;//航班
		var data_departure_flight = document.getElementById("flight_name").getAttribute("data-FlightNo");
		var data_departure_flight_name = document.getElementById("flight_name").getAttribute("data-FlightCompany");

		var FlightDeptimePlanDate = document.getElementById("flight_name").getAttribute("data-FlightDeptimePlanDate");
		var FlightArrtimePlanDate = document.getElementById("flight_name").getAttribute("data-FlightArrtimePlanDate");
		var FlightDepAirport = document.getElementById("flight_name").getAttribute("data-FlightDepAirport");
		var FlightArrAirport = document.getElementById("flight_name").getAttribute("data-FlightArrAirport");

		var data_departure_flight_info = FlightDepAirport+getHourM(FlightDeptimePlanDate)+" - "+FlightArrAirport+getHourM(FlightArrtimePlanDate);
		var data_departure_airport_code = document.getElementById("depart_name").getAttribute("data-AirportCode");
		var data_airport_1_code = document.getElementById("dest_name").getAttribute("data-AirportCode");
		api.openWin({
			name: 'reservations_win',
			url: 'reservations_win.html',
			pageParam:{
				park_id:park_id,
				parkData:parkData,
				data_departure_airport_code:data_departure_airport_code,
				data_airport_1_code:data_airport_1_code,
				data_departure_airport:data_departure_airport,//去程机场
				data_airport_1:data_airport_1,//去程目的地机场
				data_departure_time:data_departure_time,//出发时间
				data_departure_flight:data_departure_flight,//航班号
				data_departure_flight_info:data_departure_flight_info,
				data_departure_flight_name:data_departure_flight_name//航空公司
			}
		});
	}
	function getHourM(date){
		var d = new Date(date);
		var h = d.getHours();
		var m = d.getMinutes();
		var hm = h+":"+m;
		return hm;
	}
	// 出发时间选择
	function getDate(date){
		if(date){
			document.getElementById("depart_date").textContent = date;
		}
	}

</script>
</html>
