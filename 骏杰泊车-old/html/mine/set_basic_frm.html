<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>Hello APP</title>
    <link rel="stylesheet" type="text/css" href="../../css/aui.css" />
    <link rel="stylesheet" type="text/css" href="../../css/aui-flex.css" />
    <link rel="stylesheet" type="text/css" href="../../css/common.css" />
    <style type="text/css">
    	body{
    		background-color:#F6F8FA;
    	}
        .sec{
            padding:0 0.75rem;
            background: #ffffff;
        }
        .sec.list{
            margin-top:0.3rem;
            padding:0 0.75rem;
            background: #ffffff;
            font-size:0.75rem;
        }
        .list-top{
            height:7.2rem;
        }
        .list-bottom{
            height:2.5rem;
        }
        .left{
            font-size:0.75rem;
        }
        .right{
            color:#999999;
            font-size:0.7rem;
            padding-right:1rem;
        }
        .sex li{
            display: inline-block;
            padding: 0.15rem 0rem 0.15rem 1rem;
            margin-left: 0.75rem;
            background: url(../../image/common/5.png) no-repeat left center;
            background-size: 0.75rem;
        }
        .sex .nan{
            padding-right:30px;
        }
        .sex li.check {
            background: url(../../image/common/4.png) no-repeat left center;
            background-size: 0.75rem;
        }
    </style>
</head>
<body>
    <!-- 重做 -->
    <div class="content">
        <div id="doT-Html"></div>
        <script type="text/x-dot-template" id="doT-Template">
        <div class="sec">
            <div class="list-top aui-flex-col aui-flex-middle aui-flex-between right-arrow" tapmode onclick="openActionSheet(this)">
                <div class="left">更换头像</div>
                <div class="right">
                    {{?it.data.user_avatar !== null}}
                    <img src="{{=SITE_URL}}/{{=it.data.user_avatar}}" class="aui-img-round" style="width: 4.2rem;" id="avatar">
                    {{??}}
                    <img src="../../image/logo.png" style="width: 4.2rem;" id="avatar">
                    {{?}}
                </div>
            </div>
        </div>
        <div class="sec list">
            <div class="list-bottom aui-border-b aui-flex-col aui-flex-middle aui-flex-between right-arrow" tapmode onclick="openName(this)">
                <div class="left">姓名</div>
                <div class="right">{{=it.data.user_name}}</div>
            </div>
            <div class="list-bottom aui-border-b aui-flex-col aui-flex-middle aui-flex-between">
                <div class="left">性别</div>
                <ul class="sex right aui-flex-col aui-flex-middle">
                    <li class="{{? it.data.user_sex=="1" }}check{{? }} nan" tapmode onclick="select(0)">男</li>
                    <li class="{{? it.data.user_sex=="2" }}check{{? }}" tapmode onclick="select(1)">女</li>
                </ul>
            </div>
            <div class="list-bottom aui-flex-col aui-flex-middle aui-flex-between right-arrow" tapmode onclick="openBir(this)">
                <div class="left">生日</div>
                <div class="right" id="birthday">{{=it.data.user_birthday}}</div>
            </div>
        </div>
        </script>
    </div>
    <!-- 以上为重做 -->
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript" src="../../script/dom7.js"></script>
<script type="text/javascript" src="../../script/dot.min.js"></script>
<script type="text/javascript">
    // document.querySelector("#doT-Html").innerHTML = doT.template(document.querySelector("#doT-Template").innerHTML)();
    var userid;
    var imgURL;
    var postData = {};
    var uplode;
    apiready = function(){
        api.parseTapmode();
        userid = $api.getStorage('userid');
        userInfo();//个人信息
    }
    function select(num){
        $$('.sex li').removeClass('check').eq(num).addClass('check');
        var sex = num+1;
        var postData = {};
        postData.userid = userid;
        postData.sex = sex;
        api.ajax({
            url: BASE_URL + 'App/Mine/editInfo',
            method: 'post',
            data: {
                values:postData
            }
        }, function(ret, err) {
            if (ret) {
                if(ret.code == "1"){
                    api.sendEvent({
                        name: 'userEditSucess'
                    });
                    //alert(JSON.stringify(ret));
                }else{
                    // alert(JSON.stringify(ret.msg));
                }
            }
        });
    }
    //更换头像
    function openActionSheet(n){
        var _this = n;
        var sourceType = '';
        api.actionSheet({
            //title: '性别',
            buttons: ['拍照', '从手机相册选择']
        }, function(ret, err) {
            if(ret){
                var index = ret.buttonIndex;
                switch (index) {
                    case 1:
                        sourceType = 'camera';
                        break;
                    case 2:
                        sourceType = 'library';
                        break;
                    default:
                        break;
                }
                if(sourceType){
                    api.getPicture({
                      sourceType: sourceType,
                      encodingType: 'jpg',
                      mediaValue: 'pic',
                      destinationType: 'url',
                      allowEdit: true,
                      quality: 100,
                      targetWidth: 168,
                      targetHeight: 168,
                      saveToPhotoAlbum: false
                    }, function(ret, err) {
                        if (ret) {
                            $api.attr($api.byId('avatar'), 'src' , ret.data);
                            // imgURL = SITE_URL+"/"+ret.data;
                            // postData.userid = userid;
                            // postData.avatar = imgURL;
                            api.ajax({
                                url: BASE_URL+'Attachment/Index/upload',
                                method: 'post',
                                data: {
                                    // values:postData,
                                    files: {
                                        file:ret.data
                                    }
                                }
                            }, function(ret, err) {
                                if (ret) {
                                    // alert(JSON.stringify(ret));
                                    // document.getElementById("avatar").src = SITE_URL+"/"+ret.path;
                                    uplode = ret.path;
                                    editInfo();
                                }
                            });
                        } else {
                        }
                    });
                }
            }
        });
    }

    // 修改姓名
    function openName(n){
        var _this = n;
        var title = $api.text( $api.eq(_this,1) );
        var text = $api.text( $api.eq(_this,2) );
        api.prompt({
            title: title,
            msg: '',
            text: text,
            buttons: ['确定', '取消']
        }, function(ret, err) {
            var index = ret.buttonIndex;
            var text_new = ret.text;
            if(index == 1){
                $api.text( $api.eq(_this,2) , text_new );
                var postData = {};
                postData.userid = userid;
                postData.name = text_new;
                api.ajax({
                    url: BASE_URL + 'App/Mine/editInfo',
                    method: 'post',
                    data: {
                        values:postData
                    }
                }, function(ret, err) {
                    if (ret) {
                        if(ret.code == 1){
                            api.sendEvent({
                                name: 'userEditSucess'
                            });
                            // alert(JSON.stringify(ret));
                        }else{
                            // alert(JSON.stringify(ret.msg));
                        }
                    }
                });
            }
        });
    }

    //日期选择器  (生日)
    function openBir(n){
        api.openFrame({
			name: 'birthday_mask',
			url: 'birthday_mask.html',
			rect: {
				x: 0,
				y: 0,
				w: 'auto',
				h: 'auto'
			},
			pageParam: {
                birthday: $$('#birthday').text(),
				wname: api.winName,
				fname: api.frameName
			}
		});
    }
	//返回数据更改
	function changeData(domId,name){
		$$('#'+ domId).text(name);
        var postData = {};
        postData.userid = userid;
        postData.birthday = name;
        api.ajax({
            url: BASE_URL + 'App/Mine/editInfo',
            method: 'post',
            data: {
                values:postData
            }
        }, function(ret, err) {
            if (ret) {
                if(ret.code == 1){
                    api.sendEvent({
                        name: 'userEditSucess'
                    });
                    // alert(JSON.stringify(ret));
                }else{
                    // alert(JSON.stringify(ret.msg));
                }
            }
        });
	}

    // 客户端个人信息
    function userInfo(){
        var postData = {};
        postData.userid = userid;
        api.ajax({
            url: BASE_URL + 'App/Mine/userInfo',
            method: 'post',
            data: {
                values:postData
            }
        }, function(ret, err) {
            if (ret) {
                // alert("正确"+JSON.stringify(ret));
                if(ret.code == 1){
                    var tpl = document.getElementById("doT-Template").innerHTML;
                    var tempFn = doT.template(tpl);
                    document.getElementById("doT-Html").innerHTML = tempFn(ret);
                    // var avatar = ret.data.user_avatar;
                }
            }else{
                // alert("错误"+JSON.stringify(err));
            }
        });
    }
    function editInfo(){
        postData.userid = userid;
        postData.avatar = uplode;//上传的图片地址
        api.ajax({
            url: BASE_URL + 'App/Mine/editInfo',
            method: 'post',
            data: {
                values:postData
            }
        }, function(ret, err) {
            if (ret) {
                if(ret.code  == 1){
                    api.sendEvent({
                        name: 'userEditSucess'
                    });
                    userInfo();
                }
            }
        });
    }
</script>
</html>
