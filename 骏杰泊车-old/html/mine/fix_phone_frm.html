<!doctype html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
    <meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
    <title>Hello APP</title>
    <link rel="stylesheet" type="text/css" href="../../css/aui.css" />
    <link rel="stylesheet" type="text/css" href="../../css/aui-flex.css" />
    <link rel="stylesheet" type="text/css" href="../../css/common.css" />
    <script type="text/javascript" src="../../script/dot.min.js"></script>
    <style type="text/css">
	    /*重写*/
	    .sec{
            margin-top:0.3rem;
            background-color: #FFF;
            padding: 0 0.75rem;
            margin-bottom:0.75rem;
        }
        .list{
            height:2.5rem;
            font-size:0.75rem;
        }
        .sec .left{
        	width: 4rem;

        }
        .sec input{
        	font-size:0.75rem;
        }
        .code-number{
        	width: 100px;
        }
        .code{
        	font-family: PingFang-Regular;
        	font-size:0.75rem;
        	color:#083a91;
        }
        #count{
            font-family: PingFang-Regular;
            font-size:0.75rem;
            color:#083a91;
        }
    </style>
</head>
<body>
    <div id="doT-Html"></div>
    <script type="text/x-dot-template" id="doT-Template">
	<div class="cotent">
		<div class="sec">
			<div class="list aui-border-b aui-flex-col aui-flex-middle">
				<div class="left">密码</div>
                <div class="input">
                	<input type="password" placeholder="请输入密码" id="password">
                </div>
			</div>
			<div class="list aui-border-b aui-flex-col aui-flex-middle">
				<div class="left">新手机号</div>
                <div class="input">
                	<input type="password" placeholder="请输入手机号" id="mobile">
                </div>
			</div>
			<div class="list aui-flex-col aui-flex-middle aui-flex-between">
				<div class="aui-flex-col aui-flex-middle">
					<div class="left">验证码</div>
					<div class="code-number"><input type="number" placeholder="请输入验证码" id="code"></div>
				</div>
                <div class="code" tapmode onclick="code()" id="getCode">获取验证码</div><span id="count"></span>
			</div>
		</div>
		<div>
			<div class="aui-padded-15" tapmode onclick="fixPhone()">
				<div class="com-btm-btn">确认</div>
			</div>
		</div>
	</div>
    </script>
</body>
<script type="text/javascript" src="../../script/api.js"></script>
<script type="text/javascript">
    document.querySelector("#doT-Html").innerHTML = doT.template(document.querySelector("#doT-Template").innerHTML)();
    var userid;
    apiready = function(){
        api.parseTapmode();
        userid = $api.getStorage('userid');
    };
    // 重新发送验证码
    var wait = 60;
    function time(){
        if(wait == 0){
            document.getElementById("count").innerHTML = "";
            document.getElementById("getCode").innerHTML = "获取验证码";
            wait = 60;
        }else{
            document.getElementById("getCode").innerHTML = "重新获取验证码";
            document.getElementById("count").innerHTML = "(" + wait + ")";
            wait--;
            setTimeout(function(){
                time();
            },1000);
        }
    }
    // 检查手机号
    function checkMobile(){
        var mobile = document.getElementById("mobile").value;
        var phoneRule = /^0?1[3|4|5|7|8][0-9]\d{8}$/;
        if(mobile.length == 0){
            api.toast({
                msg: '手机号不能为空',
                location:'middle'
            });
            return false;
        }else if(!phoneRule.test(mobile)){
            api.toast({
                msg: '手机号不合法!',
                location:'middle'
            });
            return false;
        }
        return mobile;
    }
    // 获取验证码
    function code(){
        document.getElementById("mobile").blur();
        document.getElementById("code").blur();
        if(wait == 60 && checkMobile()){
            time();
            var mobile = document.getElementById("mobile").value;
            var code = document.getElementById("code").value;
            var postData = {};
            postData.mobile = mobile;
            postData.code = code;
            postData.userid = userid;
            api.ajax({
                url: BASE_URL +'App/Login/userCode',
                method: 'post',
                headers: {
                    'DM-APPKEY': '123456'
                },
                data: {
                    values:postData
                }
            }, function(ret, err) {
                if (ret) {
                    if(ret.code == "1"){
                        alert(JSON.stringify(ret));
                    }
                }else{
                    alert(JSON.stringify(err));
                }
            });
        }
    }
    // 修改手机号
    function fixPhone(){
        document.getElementById("password").blur();
        // document.getElementById("mobile").blur();
        // document.getElementById("code").blur();
        // var password = document.getElementById("password").value;
        var mobile = document.getElementById("mobile").value;
        // var code = document.getElementById("code").value;
        var postData = {};
        postData.mobile = checkMobile();
        postData.code = code;
        if(checkMobile()){
            if(!(postData.code && postData.mobile)){
                api.toast({
                    msg: '请输入验证码',
                    location:'middle'
                });
                return;
            }
        }
        api.ajax({
            url: BASE_URL + 'App/Mine/editMobile',
            method: 'post',
            data: {
                values:postData
            }
        }, function(ret, err) {
            if (ret) {
                if(ret.code == "1"){
                    // 注册成功 跳转到登录界面
                    setTimeout(function(){
                        api.closeToWin({
                            name: 'login_win'
                        });
                    },500)
                }else if(ret.code == "-1"){
                    // 验证码错误
                    alert("验证码错误");
                }else if(ret.code == "-2"){
                    //验证码超时
                    alert("验证码超时");
                }else if(ret.code == "-3"){
                    //此号码已被注册
                    alert("此号码已被注册");
                }else if(ret.code == "-4"){
                    //系统错误 注册失败
                    alert("系统错误 注册失败");
                }else if(ret.code == "-5"){
                    //手机号已被使用
                    alert("手机号已被使用");
                }
            }
        });
    }
</script>
</html>
